### Лекция по теме "Практическое знакомство с Jenkins"


Алексей
Метляков

### Алексей Метляков
DevOps Engineer
OpenWay
Алексей Метляков

### План занятия
1. Jenkins
2. Сущности Jenkins
3. Дополнения
4. Итоги
5. Домашнее задание

### Jenkins

### Что такое Jenkins?
Jenkins – ППО для управления CI\CD процессами.
- OpenSource – следовательно, бесплатен
- Многофункционален – имеет большое количество видов использования автоматизаций
- Имеет возможность расширения
- Использует встроенные синтаксисы: groovy и pipeline
- [сайт с плагинами](https://plugins.jenkins.io/)

### Что такое Jenkins?
Некоторые основные возможности системы:
- создание конвейера автоматизации,
- создание и управление пользователями,
- синхронизация с AD,
- ограничение прав пользователей на разных вложенностях сущностей,
- установка плагинов,
- настройка Custom Tool,
- использование динамических и статических окружений.

### Архитектура Jenkins    - 00:18:00
- User - пользователь.
- Main host - хост, где установлен Jenkins и на нем висит процесс Jenkins. На Main host работают:
  - HTTP - протокол подключения пользователя к интерфейсц Мастера
  - JNLP - протокол сетевого соединения от Java
  - Localhost master
  - SSH - протокол сетевого соединения между Мастером и Агентом
  - Extension - для работы с динамически подключаемыми хостами    - 00:25:40
- Static slave
- Dynamic slave
- Cloud 1
- Cloud 2

- 00:20:00 - про то что нужно сначала связать Мастер и Агент по ssh
- 00:29:00 - преимущества и недостатки статических хостов и динамических.
- 00:46:00 - о том. что бывает когда на Jenkins большая нагрузе\ка и что делать

### Сущности Jenkins     - 00:48:00

### Freestyle Job     - 00:48:40
> **Freestyle Job** – простейшее описание рутины в виде
> последовательно выполняемых заданий. Можно описывть то что необходимо делать на том языке, на котором хочешь: Bash, Python, Groove и пр.
> Внутри репозитория можно создавать Bash скрипты и с помощью Job вызывать скрипты. При этом код Job тоже будет в репозитории

- Задача может быть описана удобным способом
- Часть заданий можно описать в репозитории

### Groovy     - 00:49:30
> Groovy – объектно-ориентированный язык программирования разработанный, как дополнение к java.
> Больше о самом языке на их [официальном сайте](http://www.groovy-lang.org/index.html)

- Apache 2 License
- Может быть языком статической типизации. Когда переменной задают конкретный тип, например, строковый.
- Может быть языком динамической типизации. Когда переменную используют для хранения каких-то данных.
- Имеет встроенный синтаксис для работы с массивами, списками и регулярками
- Считается смесью java и python, ruby и smalltalk



- 00:50:25 - API Jenkins - плохой инструмент, лучше использовать Groovy код и запускать его Job-ой
- 00:50:46 - через Groovy с любыми объектами самого Jenkins можешь работать как с экземплярами классов. 
> Весь Jenkins построен на классах. Мастер процесс - это какой-то Класс, в котором есть методы, которые можно повызывать. 
> Каждый агент - это экземпляр Класса. Каждая Job-а - это тоже экземпляр классов. Сам текст, который нужно выполнять - это свойства в какой-то строке.
> А все остальное - вызов это строки, остановку, килл, дестрой тоже можно сделать как вызов метода конкретно этого экземпляра. 
> При этом начинаешь думать классами, ставить классы и вокруг нас - одноклассники образовываться.
> Начинаешь больше понимать объектно-ориентированный языки программирования.

### Groovy      - 00:52:00
В контексте Jenkins’a, groovy может нас заинтересовать следующими объектами:
- Package jenkins
  - jenkins.*
  - jenkins.model.*
- Package hudson
  - hudson.*
  - hudson.model.*
Для полноценного использования можно ознакомится с содержимым [официальной страницы](https://javadoc.jenkins.io/overview-summary.html)

- 00:53:45 - показано что на этом сайте и как работать
> Показаны объекты и классы, через которые можно даже свойства и настройки самого Jenkins изменять.
- 00:55:40 - пример создания нового объекта.
- 00:57:10 - описание показанного ниже скрипта:

```
Jenkins.instance.computers.each{
  println "${it.displayName} ${it.hostName}"
}
```

- 00:57:36 - этот Groove ты можешь использовать как администратор, и тогда ты используешь Package jenkins и Package hudson.
> Если хочешь написать что-то свое для автоматизации, пишешь спокойно так, как ты пишешь на Java. Там Package jenkins и Package hudson не особо сильно 
> нужны. Просто пишешь обычный скрипт. Импортируешь нужные библиотеки для Java.

## Практическая часть лекции     - 01:00:35
- 01:00:35 - практическая часть лекции
- 01:02:55 - выбираем плагины для установки
- 01:53:55 - о сайте [Plugin Jenkins](https://plugins.jenkins.io/)

> На примере plugin [Docker](https://plugins.jenkins.io/docker-plugin/) описано как использовать Docker в качестве облака для контейнеров Агентов.
> - 01:05:15 - как скачивать Релизы

- 01:06:10 - создание первого Админа
- 01:06:40 - Jenkins URL - для подключения для DNS или, например, BeetBacket, чтобы он мог собираться по коммиту.
- 01:07:25 - Старт Jenkins
- 01:09:45 - про ноду Мастер. 

> Отключить сборки на Мастере. Он и так загружен вычитками. Сборки делать на Агентах.

### Настройка новой ноды для Агента
- 01:11:05 - создание новой ноды для Агента.

```
  - Настройка jenkins --> Управление средами сборки --> Новый узел. Дать название. Centos7-agent --> Create
  - Number executer - 2
  - Корень удаленной файловой системы. Узнать это можно из playbook файле Jenkins.yml
```
> Узнаем это из playbook из файла `Jenkins.yml`
>  ```
>  /opt/jenkins_agent/
>  
>  ```
>  Это нужно для того, чтобы все сборки на Агенте создавались внутри этой директории.

- 01:13:40 - Метки. По этим меткам пользователи могут использовать разные агенты. Например: `centos docke ansible custom`

> При этом в настрйках агента должны быть выставлены параметры "ограничить лейблы сборщиков - `centos docke ansible custom`"
> А в настройке сборщика должны быть параметры "Использование: `Only build jobs ...`"

> Если в настрйках агента выставлены параметры "ограничить лейблы сборщиков" - пустое, то 
> в настройке сборщика должны быть параметры "Использование: `Use this node as match...`
> Иначе сборка может не запуститься.

- 01:18:15 - про ключ SSH и Credentials. 
> Указать ключ, указать адрес агента для подключения.

- Использование: `Only build jobs ...`
- Способ запуска: `Launch agent via execution...`
- 01:21:20 - Команда запуска для примера `ssh <ip hostname> java -jar ~/bin/agent.jar`  
```
ssh 62.84.117.11 java -jar /opt/jenkins_agent/agent.jar
```
- 01:22:15 - Доступность. `Keep this agent online...`
- Save

- 01:25:10 - логи процесса `agent.jar`
- 01:25:20 - консоль сценариев.
> Позволяет запустить скрипт Groove на агенте через Jenkins, не заодя на агент по SSH
- 01:26:15 - Dashboard

### Что такое Freestile Job
- 01:27:40 - Freestile Job создается через меню "Создать Item"
    - Создать Item
    - Создать задачу со свободной конфигурацией. Это и есть "Freestile Job"
    - Создаем Folder, присваиваем имя `ansible-test`
> Внутри этой директории можно создавать Jobs.
> - Обычно в ролевых моделях фолдеры - это проекты. 
> - На фолдеры выдаются ограничения прав пользователей

#### Задание прав пользователям
- 01:29:45 - показано как задавать права для ползователей на доступы и возможности.
> - Настройки прав выполняются через корневое Меню "Глобальные настройки безопасности"
> - Далее в пункт "Project-Based Matrix Autorization Strategy". Можно указывать кому и что доступно на фолдерах (проектах).
> - Также можно создать "Role-Based" права на основе ролей ползователей

- 01:34:10 - настройка для пользователя возможности видеть папку проекта.
> Заходим из меню Dashboard: Все --> кликаем по названию Item `ansible-test` --> Configure 
> В пункте меню "Properties" должна появиться кнопка "Enabled Project-Based Security". Савим под ней галочку.
> Откроется матрица. В ней теперь можно добавить новго пользователя.
> Дать полные права на эту директорию проекта `ansible-test`.

- 01:34:40 - создание новой директории с новыми правами пользователя

### 1. Создание задачи "Freestile Job"
- 01:35:30 - Создание задачи "Freestile Job"
> Здесь также можно устанавливать права пользователей на конкретную Jobs.
- Настройки Item 
- General:
  - удалять устаревшие сборки - 5
  - нет. это параметризированная сборка
  - да. ограничить лейблы сборщиков - `centos docke ansible custom`

#### Пункты меню задачт "Freestile Job"
- Управление исходным кодом
  - нет. управление исхлжным кодом - Git. Указать адрес репозитория. 
  - Триггер сборки. Нужен токен для подключения по URL:
  - нет. Trigger builds remotely (e.g., from scripts)?
  - нет. Build after other projects are built?
  - нет. Запускать периодически? По правилам крона
  - нет. GitHub hook trigger for GITScm polling? Запуска сборки при изменении в Gihub
  - нет. Опрашивать SCM об изменениях? - 01:42:50 - Jenkins сам по расписанию крона идет в репозиторий и смлотрит поменялось ли там что-то или нет и определяет делать ему сборку или нет
- Среда сборки:
  - нет. Delete workspace before build starts. Очистка директории сборки после сборки
  - нет. Use secret text(s) or file(s)? Использование секретных файлов для скрытия конф. инфориации.
  - нет. Abort the build if it's stuck. Если сборка застрянет, то попытаться ее удалить, чем ждать бесконечно кода она выполнится. Также можно намтроить стратегию этого поведения.
  - нет. Add timestamps to the Console Output. В лог выполнения будет ставиться время.
  - нет. Inspect build log for published Gradle build scans. Инспекция логов для Gradle
  - нет. With Ant?
- Сборка: (выбрать один вариант) - 01:45:50
  - нет. Invoke Gradle script
  - нет. Run with timeout
  - нет. Set build status to "pending" on GitHub commit
  - нет. Вызвать Ant
  - нет. Вызвать цели Maven верхнего уровня
  - нет. Выполнить команду Windows
  - да. Выполнить команду shell. Bash скрипты, команды. Например `ansible-playbook -i inventori/host.yml site.yaml`. Нужно также
  - Послесборочные операции



### Процесс сборки. Проводится от имени пользователя test
- 01:49:08 - начало процесса сборки

### Подключение репозитория
- 01:53:10 - 
- 01:54:27 - добавление ключа от репозитория. 
> Нужно воспользоваться системой Credentials
> - Credentials можно добавлять глобально или в каждый проект отдельно. Это может зависеть от прав пользователя.
- 01:58:20 - подключение по ключу SSH. 
> - Выбираем Add --> SSH Username with private key
> - Вставляем ключ от Github в поле ключа Далее --> Add
> - В меню Credentials выбираем Git
> - Указать с какой ветки собираться. Например */* - любая ветка, */main - с ветки мастера, */feature
> - Просмотрщик - авто

- 02:02:00 - В меню "Сборка" добавляем команду для установки molecule и команду для запуска molecule
```
pip3 install molecule -r requirements.txt
molecule test
```
- 02:06:10 - Можно добавить субдиректорию через `Additional Bahaivors` для сохранения склонированных репозиториев и ветвей. Например `mnt-homeworks-ansible`
```
cd mnt-homeworks-ansible
pip3 install molecule -r requirements.txt
molecule test
```
- 02:09:42 - о параметризованных сборках
- 02:10:40 - запуск сборки с параметрами

#### Окончание пояснения по задаче "Freestile Job"     - 02:13:15

- 02:14:15 - об использовании консоли и скриптов Groove

```
Jenkins.instance.computers.each{
  println "${it.displayName} === ${it.hostName}"
}
```
```
Jenkins.instance.computers.each{
  println "${it.displayName} ${it.hostName}"
  if(it.displayName==Centos7-agent){
  it.connect()
  }
}
```
- 02:22:20 - это все можно делать и через Job,но там много ограничений по методам
- 02:23:10 - про Global Credentials
- 02:26:05 - консольные команды Jenkins CLI. Меню Dasboard --> Jenkins CLI

### Pipeline Job    - 02:27:43
> Это тоже Freestile Job, но написанный на отдельном языке, который называется "Pipeline DSL"
> Свою сборку мы разделяем на стадии Stage и шаги Steps.
> Аналогмчно Play, Task в Ansible
> Может храниться в репозитории как `Jenkinsfile`

### Pipeline Job
> Pipeline Job – описание рутины в отдельных файлах с pipeline на
> собственном синтаксисе. Удобство в большей визуализации
> различных этапов сборки и отдельной обработки каждой стадии
> (stage) при работе с шагами (steps). 
> Хранится в корне репозитория в виде файла `Jenkinsfile` или в самом Jenkins.

Может быть описано в двух видах:
- Declarative Pipeline
- Scripted Pipeline


### 12Pipeline Syntax     - 02:29:22
> Declarative Pipeline – верхнеуровневое описание того, что
> необходимо сделать. Имеет свой собственный синтаксис и описывается в файлах с именованием `Jenkinsﬁle`.

* Пример Declarative Pipeline:
```
pipeline {        # начинаем декларативный пайплайн словом pipeline
     agent any    # объявляем на каких агентах это запускать. any - на любых. Как будто мы не указали лейблы
     stages {     # стадии. По аналогии с Play в Ansible
       stage(‘Build’){    # стадия Build
            steps{        # шаги. Здесь построчно описываем вызов shell, pludin и прочего. Что нам нужно.
            }
       }
       stage(‘Test’){
            steps{
            }
         }
    }
}
```
- 02:30:40 - заполняем все stageи так создаем `Pipeline`

### 13Pipeline Syntax     - 02:31:05
> Scripted Pipeline – описание стадий конвейера с использованием
> собственного синтаксиса, но с дополнениями в виде groovy-скриптов.
> Можно внутрь Stage включать часть кода Groove


Пример Scripted Pipeline:
```
node {                      # начинаем скриптовый пайплайн словом node
                            # если указать node.Centos7-agent, то будет исполняться на указанном агенте, иначе будет выполняться на любом доступном
                            # агенте.
                            # а внутри стейджи
     stage(‘Build’){
     }
     stage(‘Test’){
     }
     if (currentBuild.currentResult == SUCCESS){      # Groove code
         stage(‘Test’){                               # вставляем стандартный код
         }
     }
}
```

### 14Pipeline Syntax     - 02:32:18
> - Jenkins был написан в тесной связи с groovy
> - Groovy нужно было изолировать от использования системных вызовов – был создан Scripted Pipeline
> - Чтобы не принуждать всех пользователей изучать groovy, был создан Declarative Pipeline с упрощенным интерфейсом.

- Полное описание работы с pipeline можно найти в [документации](https://www.jenkins.io/doc/book/pipeline/).
- 02:34:00 - сайт с документацией

### Создание задачи Pipeline на языке Pipeline DSL, а не на языке Freestyle
- Создаем: New Item --> Pipiline --> Name `run-ansible-pypline`
- В пункте `Definition`
- В меню Pipeline Script:
  - указываем какой SCM нужно использовать
  - указать адрес репозитория
  - указать имя ветки по которой будет чекаутиться, например `*/main`,
  - путь до файла скрипта `Jenkinsfile` или любого другого скрипта
Или:
- В меню Pipeline Script:
  - выбираем возможность писать скрипт в поле с текстом. Этим можно оперативно проверять правильность скрипта.
  - пишем текст скрипта
  - В этом случае нужен гит-плагин для скачивания репозитория

Пример скрипта:
- 02:41:20 - что писать в Steps. В меню Pipeline Syntax есть генератор кода и там все перечислено.
```
pipeline {
    agent{
        label ansible
    }
    stages{
        stage('checkout git'){
            steps{'сюда вставляем то что сделал генератор кода'}
        }
        stage('install dependence'){
            steps{
              sh 'pip3 install -r requirements.txt'
           }
        }
        stage ('run molecule'){
          steps{
            sh 'molecule test'
          }
        }
    }
}
```

- 02:43:50 - написание shell-script
- 02:45:20 - Directive code-generator. Он создает чаcть pipeline
- 02:46:00 - о параллельности работы стедж
- 02:46:53 - о снипер генераторе
- 02:48:10 - пример создания Directives
- 02:48:40 - переименовали Item на `mnt-homeworks-ansible`

### Старт сборки     - 02:48:52
- Как выглядит Stage View сборок Pipeline, который показывает как идут сборки разных стадий

- 02:51:00 - про скриптовый Pipeline. У него нет почти никакой разницы с Declarative Pipeline
> Выбрать новый Pipeline name `scripted pipeline`
> В коде скрипта слова `step` нет совсем. Есть просто `stage`

```
node('ansible') {
        stage('checkout git'){
          'сюда вставляем то что сделал генератор кода'
        }
        stage('install dependence'){
              sh 'pip3 install -r requirements.txt'
        }
        stage ('run molecule'){
            sh 'molecule test'
          }
}
```
- 02:53:20 - проверка синтаксиса

###  Старт сборки  Pipeline `scripted pipeline`  - 02:55:25
- 02:58:10 - показана директория на Агенте, где лежит склонированный репо
- 02:59:00 - о вставках в скрипт кода Groovy
- 03:09:00 - неудачная сборка, причины и как исправить.
- 03:10:00 - создание новой ветки в Git `bugix/fix_pipeline` ответки `main` т редактируем Jenkinsfile
```
Jenkinsfile
  pipeline{
      agent{
        label 'linux'
      }  
      stages{
          stage('Install molecule'){
              steps{
                  sh 'cd mnt-homeworks-ansible && pip3 install -r requirements.txt'
                  sh 'echo ==========='
              }
          }
          stage('Run molecule'){
              steps{
                 sh 'cd mnt-homeworks-ansible && molecule test'
              }
          }
      }
  }

```
- 03:11:12 - ручной запуск сканирования репозитория. Но ветка оказалась незапаблишенная. Она лежит локально.
- 03:13:30 - разбор почему неудачная сборка
- 03:16:00 - найдена причина неудачной сборки. Корректируем файл Jenkinsfile
```
Jenkinsfile
  pipeline{
      agent{
        label 'linux'
      }  
      stages{
          stage('Checkout role'){
              dir('mnt-homeworks-ansible'){
                 # checkout scm      # меняем на то, что было в декларативном пайплайне  - 03:17:20
                 git branch: 'main', credentialsId: '876872368723', url: 'http://123.123.123.123'
              }
      
          }
          stage('Install molecule'){
              steps{
                  dir('mnt-home-works-ansible'){
                  sh 'pip3 install -r requirements.txt'
                  sh 'echo ==========='
                  }
              }
          }
          stage('Run molecule'){
              steps{
                  dir('mnt-home-works-ansible'){
                      sh 'molecule test'
                  }
              }
          }
      }
  }

```
- 03:18:35 - коррекция Item `multibranch`
- 03:20:00 - неудачная сборка и поиск причин через Console Output. Коррекция файла Jenkinsfile. Добавление секций steps
```
Jenkinsfile
  pipeline{
      agent{
        label 'linux'
      }  
      stages{
          stage('Checkout role'){
              steps{
                  dir('mnt-homeworks-ansible'){
                      # checkout scm      # меняем на то, что было в декларативном пайплайне  - 03:17:20
                     git branch: 'main', credentialsId: '876872368723', url: 'http://123.123.123.123'
                  }
              }
          }
          stage('Install molecule'){
              steps{
                  dir('mnt-home-works-ansible'){
                  sh 'pip3 install -r requirements.txt'
                  sh 'echo ==========='
                  }
              }
          }
          stage('Run molecule'){
              steps{
                  dir('mnt-home-works-ansible'){
                      sh 'molecule test'
                  }
              }
          }
      }
  }

```
### Успешный запуск сборки Multibranch Pipeline - 03:22:08 

- 03:22:45 - ! комментарии по фишкам в работе с Git, сборке по Pull Request. Как мержатся ветки fix, main при их изменениях и запускается сборка до их реального сляния в репозитории в Git.

#### Успешное окончание сборки      -03:26:40
- 03:26:48 - на Github.com смерживается ветка. Нажимаем кнопку `Merge Pull Request
- 03:27:10 - успешный автоматический запуск сборки


### 15Multibranch Pipeline      - 02:59:45
> Multibranch Pipeline – вид Pipeline, который умеет запускать сборки
> по действиям в рамках одного репозитория.
> Сборка запускается даже если в любой ветке произойдет изменение. Jenkins это отловит и запустит сборку.
> Сборка запускается автомтически по тегам


- Умеет разделять виды действий в репозитории
- Фильтровать имена branches

- 03:00:52 - для Multibranch Pipeline  файл Jenkinsfile должен лежать в корне репозитория.
- 03:01:22 - пояснение по Jenkinsfile. Это тот же файл с Pipeline какой и был нами ранее написан.
- 03:02:10 - создаем новый Item на основе 'Multibranch" с именем `multibranch`




### 16Дополнения      - 03:28:33

### 17Blue Ocean
Blue Ocean – новый UI для Jenkins. Призван улучшить читаемость
происходящего и сделать более качественную визуализацию
прохождения этапов сборки.
Изначально вырос из концепции Blue Ocean Strategy: нужно
рассматривать проблему более широко, чем просто смотреть туда,
где она возникла.

### 18Ansible     - 03:36:40
Ansible – добавляет возможность запускать ansible через синтаксис
Declarative Pipeline. Фактически, избавляет от необходимости
вызова оболочки для вызова плейбука.
Пример синтаксиса можно посмотреть на [официальной странице](https://plugins.jenkins.io/ansible/)
плагина:
```
ansiColor('xterm') {
    ansiblePlaybook(
        playbook: 'path/to/playbook.yml',
        inventory: 'path/to/inventory.ini',
        credentialsId: 'sample-ssh-key',
        colorized: true)
}
````

### 19Docker      - 03:39:55
Docker – позволяет осуществлять сборки на docker-контейнерах.
Также позволяет собирать собственные образы и выкладывать их в
Registry. Особенности настройки и работы можно посмотреть на [странице](https://plugins.jenkins.io/docker-plugin/).

### 20Monitoring      - 03:40:50
Monitoring – плагин, позволяющий отслеживать java-процессы через
JavaMelody. Можно отслеживать как процессы master, так и agents.
Позволяет:
- проверять работоспособность потоков,
- смотреть созданные объекты в heap,
- вызывать GC,
- собирать heapdump.

### 21Итоги     - 03:47:50

### 22Итоги
- Master – основной процесс Jenkins, он же исполнитель на ноде
- Agent – java процесс на отдельном хосте для выполнения job
- Job – описание рутинного рабочего процесса
- Job может быть нескольких видов, основные
  - Freestyle
  - Pipeline
- Существует огромный набор расширений функционала
- Инструмент обладает гибкостью в настройке
- Полностью бесплатен

### 23Домашнее задание      - 03:49:45
Давайте посмотрим ваше домашнее задание.
- Вопросы по домашней работе задавайте в чате мессенджера
Slack.
- Задачи можно сдавать по частям.
- Зачёт по домашней работе проставляется после того, как приняты
все задачи.

### 24Задавайте вопросы и
пишите отзыв о лекции!
Алексей Метляков
Алексей Метляков
