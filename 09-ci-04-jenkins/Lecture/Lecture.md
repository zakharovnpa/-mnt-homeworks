### Лекция по теме "Практическое знакомство с Jenkins"


Алексей
Метляков

### 1Алексей Метляков
DevOps Engineer
OpenWay
Алексей Метляков

### 2План занятия
1. Jenkins
2. Сущности Jenkins
3. Дополнения
4. Итоги
5. Домашнее задание

### 3Jenkins

### 4Что такое Jenkins?
Jenkins – ППО для управления CI\CD процессами.
- OpenSource – следовательно, бесплатен
- Многофункционален – имеет большое количество видов использования автоматизаций
- Имеет возможность расширения
- Использует встроенные синтаксисы: groovy и pipeline
- [сайт с плагинами](https://plugins.jenkins.io/)

### 5Что такое Jenkins?
Некоторые основные возможности системы:
- создание конвейера автоматизации,
- создание и управление пользователями,
- синхронизация с AD,
- ограничение прав пользователей на разных вложенностях сущностей,
- установка плагинов,
- настройка Custom Tool,
- использование динамических и статических окружений.

### 6Архитектура Jenkins    - 00:18:00
- User - пользователь.
- Main host - хост, где установлен Jenkins и на нем висит процесс Jenkins. На Main host работают:
  - HTTP
  - JNLP - протокол сетевого соединения от Java
  - Localhost master
  - SSH
  - Extension - для работы с динамически подключаемыми хостами    - 00:25:40

- 00:20:00 - про то что нужно сначала связать Мастер и Агент по ssh
- 00:29:00 - преимущества и недостатки статических хостов и динамических.
- 00:46:00 - о том. что бывает когда на Jenkins большая нагрузе\ка и что делать



Static
slave

Static
slave



Static
slave
Static
slave
Cloud 1


Static
slave
Dynamic
slave
Cloud 2
Dynamic
slave



### 7Сущности Jenkins     - 00:48:00

### 8Freestyle Job     - 00:48:40
Freestyle Job – простейшее описание рутины в виде
последовательно выполняемых заданий. Можно описывть то что необходимо делать на том языке, на котором хочешь. Bash, Python, Groove и пр.
Внутри репозитория можно создавать Bash скрипты и с помощью Job вызывать скрипты. При этом код Job тоже будет в репозитории
- Задача может быть описана удобным способом
- Часть заданий можно описать в репозитории

### 9Groovy     - 00:49:30
Groovy – объектно-ориентированный язык программирования разработанный, как дополнение к java.
- Apache 2 License
- Может быть языком статической типизации. Когда переменной задают конкретный тип, например, строковый.
- Может быть языком динамической типизации. Когда переменную используют для хранения каких-то данных.
- Имеет встроенный синтаксис для работы с массивами, списками и регулярками
- Считается смесью java и python, ruby и smalltalk
Больше о самом языке на их [официальном сайте](http://www.groovy-lang.org/index.html)

- 00:50:25 - API Jenkins - плохой инструмент, лучше использовать Groovy код и запускать его Job-ой
- 00:50:46 - через Groovy с любыми объектами самого Jenkins можешь работать как с экземплярами классов. 
> Весь Jenkins построен на классах. Мастер процесс - это какой-то Класс, в котором есть методы, которые можно повызывать. 
> Каждый агент - это экземпляр Класса. Каждая Job-а - это тоже экземпляр классов. Сам текст, который нужно выполнять - это свойства в какой-то строке.
> А все остальное - вызов это строки, остановку, килл, дестрой тоже можно сделать как вызов метода конкретно этого экземпляра. 
> При этом начинаешь думать классами, ставить классы и вокруг нас - одноклассники образовываться.
> Начинаешь больше понимать объектно-ориентированный языки программирования.

### 10Groovy      - 00:52:00
В контексте Jenkins’a, groovy может нас заинтересовать следующими
объектами:
- Package jenkins
  - jenkins.*
  - jenkins.model.*
- Package hudson
  - hudson.*
  - hudson.model.*
Для полноценного использования можно ознакомится с содержимым [официальной страницы](https://javadoc.jenkins.io/overview-summary.html)
- 00:53:45 - показано что на этом сайте и как работать
> Показаны объекты и классы, через которые можно даже свойства и настройки самого Jenkins изменять.
- 00:55:40 - пример создания нового объекта.
- 00:57:10 - описание показанного ниже скрипта:
```
Jenkins.instance.computers.each{
  println "${it.displayName} ${it.hostName}"
}
```
- 00:57:36 - этот Groove ты можешь использовать как администратор, и тогда ты используешь Package jenkins и Package hudson.
> Если хочешь написать что-то свое для автоматизации, пишешь спокойно так, как ты пишешь на Java. Там Package jenkins и Package hudson не особо сильно 
> нужны. Просто пишешь обычный скрипт. Импортируешь нужные библиотеки для Java.
- 01:00:35 - практическая часть лекции
- 01:02:55 - выбираем плагины для установки
- 01:53:55 - о сайте [Plugin Jenkins](https://plugins.jenkins.io/)
> На примере plugin [Docker](https://plugins.jenkins.io/docker-plugin/) описано как использовать Docker в качестве облака для контейнеров Агентов.
> - 01:05:15 - как скачивать Релизы
- 01:06:10 - создание первого Админа
- 01:06:40 - Jenkins URL - для подключения для DNS или, например, BeetBacket, чтобы он мог собираться по коммиту.
- 01:07:25 - Старт Jenkins
- 01:09:45 - про ноду Мастер. 
> Отключить сборки на Мастере. Он и так загружен вычитками. Сборки делать на Агентах.

### Настройка новой ноды для Агента
- 01:11:05 - создание новой ноды для Агента.
```
  - Настройка jenkins --> Управление средами сборки --> Новый узел. Дать название. Centos7-agent --> Create
  - Number executer - 2
  - Корень удаленной файловой системы. Узнать это можно из playbook файле Jenkins.yml
```
> В файле `Jenkins.yml`
>  ```
>  /opt/jenkins_agent/
>  
>  ```
>  Это нужно для того, чтобы все сборки на Агенте создавались внутри этой директории.

- 01:13:40 - Метки. По этим меткам пользователи могут использовать разные агенты. Например: `centos docke ansible custom`
> При этом в настрйках агента должны быть выставлены параметры "ограничить лейблы сборщиков - `centos docke ansible custom`"
> А в настройке сборщика должны быть параметры "Использование: `Only build jobs ...`"

> Если в настрйках агента выставлены параметры "ограничить лейблы сборщиков" - пустое, то 
> в настройке сборщика должны быть параметры "Использование: `Use this node as match...`
> Иначе сборка может не запуститься.

- 01:18:15 - про ключ SSH и Credentials. 
> Указать ключ, указать адрес агента для подключения.

- Использование: `Only build jobs ...`
- Способ запуска: `Launch agent via execution...`
- 01:21:20 - Команда запуска для примера `ssh <ip hostname> java -jar ~/bin/agent.jar`  
```
ssh 62.84.117.11 java -jar /opt/jenkins_agent/agent.jar
```
- 01:22:15 - Доступность. `Keep this agent online...`
- Save

- 01:26:15 - Dashboard
- 01:27:40 - Freestile Job








### 11Pipeline Job
Pipeline Job – описание рутины в отдельных файлах с pipeline на
собственном синтаксисе. Удобство в большей визуализации
различных этапов сборки и отдельной обработки каждой стадии
(stage) при работе с шагами (steps). Хранится в репозитории или в
самом Jenkins.
Может быть описано в двух видах:
- Declarative Pipeline
- Scripted Pipeline

### 12Pipeline Syntax
Declarative Pipeline – верхнеуровневое описание того, что
необходимо сделать. Имеет свой собственный синтаксис и
описывается в файлах с именованием Jenkinsﬁle.
Пример Declarative Pipeline:
```
pipeline {
     agent any
     stages {
       stage(‘Build’){
            steps{
            }
       }
       stage(‘Test’){
            steps{
            }
         }
    }
}
```

### 13Pipeline Syntax
Scripted Pipeline – описание стадий конвейера с использованием
собственного синтаксиса, но с дополнениями в виде groovy-
скриптов.
Пример Scripted Pipeline:
```
node {
     stage(‘Build’){
     }
     stage(‘Test’){
     }
     if (currentBuild.currentResult == SUCCESS){
         stage(‘Test’){
         }
     }
}
```

### 14Pipeline Syntax
- Jenkins был написан в тесной связи с groovy
- Groovy нужно было изолировать от использования системных вызовов – был создан Scripted Pipeline
- Чтобы не принуждать всех пользователей изучать groovy, был
создан Declarative Pipeline с упрощенным интерфейсом.
Полное описание работы с pipeline можно найти в [документации](https://www.jenkins.io/doc/book/pipeline/).

### 15Multibranch Pipeline
Multibranch Pipeline – вид Pipeline, который умеет запускать сборки
по действиям в рамках одного репозитория.
- Умеет разделять виды действий в репозитории
- Фильтровать имена branches

### 16Дополнения

### 17Blue Ocean
Blue Ocean – новый UI для Jenkins. Призван улучшить читаемость
происходящего и сделать более качественную визуализацию
прохождения этапов сборки.
Изначально вырос из концепции Blue Ocean Strategy: нужно
рассматривать проблему более широко, чем просто смотреть туда,
где она возникла.

### 18Ansible
Ansible – добавляет возможность запускать ansible через синтаксис
Declarative Pipeline. Фактически, избавляет от необходимости
вызова оболочки для вызова плейбука.
Пример синтаксиса можно посмотреть на [официальной странице](https://plugins.jenkins.io/ansible/)
плагина:
```
ansiColor('xterm') {
ansiblePlaybook(
playbook: 'path/to/playbook.yml',
inventory: 'path/to/inventory.ini',
credentialsId: 'sample-ssh-key',
colorized: true)
}
````

### 19Docker
Docker – позволяет осуществлять сборки на docker-контейнерах.
Также позволяет собирать собственные образы и выкладывать их в
Registry. Особенности настройки и работы можно посмотреть на [странице](https://plugins.jenkins.io/docker-plugin/).

### 20Monitoring
Monitoring – плагин, позволяющий отслеживать java-процессы через
JavaMelody. Можно отслеживать как процессы master, так и agents.
Позволяет:
- проверять работоспособность потоков,
- смотреть созданные объекты в heap,
- вызывать GC,
- собирать heapdump.

### 21Итоги

### 22Итоги
- Master – основной процесс Jenkins, он же исполнитель на ноде
- Agent – java процесс на отдельном хосте для выполнения job
- Job – описание рутинного рабочего процесса
- Job может быть нескольких видов, основные
  - Freestyle
  - Pipeline
- Существует огромный набор расширений функционала
- Инструмент обладает гибкостью в настройке
- Полностью бесплатен

### 23Домашнее задание
Давайте посмотрим ваше домашнее задание.
- Вопросы по домашней работе задавайте в чате мессенджера
Slack.
- Задачи можно сдавать по частям.
- Зачёт по домашней работе проставляется после того, как приняты
все задачи.

### 24Задавайте вопросы и
пишите отзыв о лекции!
Алексей Метляков
Алексей Метляков
