# Ход выполнения ДЗ к занятию "09.04 Jenkins"

## Подготовка к выполнению

1. Создать 2 VM: для jenkins-master и jenkins-agent.
2. Установить jenkins при помощи playbook'a.
3. Запустить и проверить работоспособность.
4. Сделать первоначальную настройку.

## Основная часть

1. Сделать Freestyle Job, который будет запускать `molecule test` из любого вашего репозитория с ролью.
- 03:51:16 - 

2. Сделать Declarative Pipeline Job, который будет запускать `molecule test` из любого вашего репозитория с ролью.
- 03:51:30

3. Перенести Declarative Pipeline в репозиторий в файл `Jenkinsfile`.
- 03:51:40
- Создать файл Jenkinsfile с содержимым Declarative Pipeline и выложить в корень репозитория

4. Создать Multibranch Pipeline на запуск `Jenkinsfile` из репозитория.
- 03:51:45
> Можно делать как Алексей. С директориями помучаться
> Или можно удалить декларативный пайплайн - нет, так не получится

5. Создать Scripted Pipeline, наполнить его скриптом Jenkinsfile из [pipeline](./pipeline).
- 03:52:13
- Поменять лейбл
- Поменять CredentialsID
- url поставить свой

6. Внести необходимые изменения, чтобы Pipeline запускал `ansible-playbook` без флагов `--check --diff`, если не установлен параметр при запуске джобы (prod_run = True), по умолчанию параметр имеет значение False и запускает прогон с флагами `--check --diff`.
- 03:56:00
- Поставить ansible-galaxy
- Сделать вызов Java роли

7. Проверить работоспособность, исправить ошибки, исправленный Pipeline вложить в репозиторий в файл `ScriptedJenkinsfile`. Цель: получить собранный стек ELK в Ya.Cloud.
-03:56:48
Предупреждение о том, что все ДЗ будет переделано и надо его скачать заново.
- Забыть про репозиторий Алексея
- У нас должен был появиться плейбук, который должен был использовать наши роли Elasticsearch, Filebeat, Kibana чтобы у нас получился какой-то стек. Вот это все надо сделать в виде Scripted Pipeline для Jencinsfile, чтобы просто запустился наш ansible-playbook, но на агенте, но так, чтобы без флага (prod_run = False) он запускает с флагом `--check --diff`, а если стоит (prod_run = True), то без флага   `--check --diff`. Все.
- А как мы будем роль выкачивать - это все на откуп Credentials и вашей фантазии

8. Отправить две ссылки на репозитории в ответе: с ролью и Declarative Pipeline и c плейбукой и Scripted Pipeline.
- 03:58:28
- В итоге Должно быть два репозитория. Один из них - с Declarative Pipelin. И репозиторий  с плейбук с Scripted Pipeline.
  Короче:
  - где хранится плейбук - там Scripted Pipeline.
  - а где роль, которую я выбрал чдля тестирования серез Jenkins, там  Declarative Pipeline 
  - больше ничего не надо

## Необязательная часть     - 03:59:10

1. Создать скрипт на groovy, который будет собирать все Job, которые завершились хотя бы раз неуспешно. Добавить скрипт в репозиторий с решеним с названием `AllJobFailure.groovy`.
2. Дополнить Scripted Pipeline таким образом, чтобы он мог сначала запустить через Ya.Cloud CLI необходимое количество инстансов, прописать их в инвентори плейбука и после этого запускать плейбук. Тем самым, мы должны по нажатию кнопки получить готовую к использованию систему.

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---

---
# Ход выполнения ДЗ к занятию "09.04 Jenkins"

---
Директория выполнения заданий
```
root@PC-Ubuntu:~/ansible-learning/yandex-cloud/Kappa/
```
---

## Подготовка к выполнению

- 00:59:35 - предварительно о выполнении ДЗ.
  - Создается две ВМ для Мастера идл Агента. 
  - На эти ВМ ставятся Docker, Python, Ansible
> Нужно будет зайти на мастер по порту 8080
> С помощью xml можно сделать так, чтобы Jenkins установил все нужные плагины и настройки и не запрашивал первую страницу с авторизацией по 
> локальному паролю. И даже чтобы появились все нужные Jobs. И чтобы уже были все пользователи и пароли для них.


1. Создать 2 VM: для jenkins-master и jenkins-agent.
2. Установить jenkins при помощи playbook'a.
3. Запустить и проверить работоспособность.
- 01:00:35 - 
- 

4. Сделать первоначальную настройку.
- 01:07:20 - 
  - Настройка jenkins --> Управление средами сборки --> Мастер. Удаляем из мастера все сборки (чтобы был 0). Все сборки выполнять исключительно на агентах.

- 01:11:00 - создание новой ноды
  - Настройка jenkins --> Управление средами сборки --> Новый узел. Дать название. Centos7-agent --> Create
  - Number executer - 2
  - Корень удаленной файловой системы. Узнать это можно из playbook. На 01:12:10

В файле `Jenkins.yml`
  ```
  /opt/jenkins_agent/
  
  ```
- 01:13:40 - Метки. По этим меткам пользователи могут использовать разные агенты. Например: `centos docke ansible custom`
> При этом в настрйках агента должны быть выставлены параметры "ограничить лейблы сборщиков - `centos docke ansible custom`"
> А в настройке сборщика должны быть параметры "Использование: `Only build jobs ...`"

> Если в настрйках агента выставлены параметры "ограничить лейблы сборщиков" - пустое, то 
> в настройке сборщика должны быть параметры "Использование: `Use this node as match...`
> Иначе сборка может не запуститься.

- Использование: `Only build jobs ...`
- Способ запуска: `Launch agent via execution...`
- 01:21:20 - Команда запуска `ssh <ip hostname> java -jar ~/bin/agent.jar`  
```
ssh 62.84.117.11 java -jar /opt/jenkins_agent/agent.jar
```
- 01:22:15 - Доступность. `Keep this agent online...`
- Save

- 01:26:15 - Dashboard
- 01:27:40 - Freestile Job

## Основная часть

1. Сделать Freestyle Job, который будет запускать `molecule test` из любого вашего репозитория с ролью.
- 01:27:40 - Freestile Job
    - Создать Item
    - Создать задачу со свободной конфигурацией. Это и есть "Freestile Job"
- 01:35:30 - Создание задачи "Freestile Job"
- Настройки Item 
- General:
  - удалять устаревшие сборки - 5
  - нет. это параметризированная сборка
  - да. ограничить лейблы сборщиков - `centos docke ansible custom`

- Управление исходным кодом
  - нет. управление исхлжным кодом - Git. Указать адрес репозитория. 
  - Триггер сборки. Нужен токен для подключения по URL:
  - нет. Trigger builds remotely (e.g., from scripts)?
  - нет. Build after other projects are built?
  - нет. Запускать периодически? По правилам крона
  - нет. GitHub hook trigger for GITScm polling? Запуска сборки при изменении в Gihub
  - нет. Опрашивать SCM об изменениях? - 01:42:50 - Jenkins сам по расписанию крона идет в репозиторий и смлотрит поменялось ли там что-то или нет и определяет делать ему сборку или нет
- Среда сборки:
  - нет. Delete workspace before build starts. Очистка директории сборки после сборки
  - нет. Use secret text(s) or file(s)? Использование секретных файлов для скрытия конф. инфориации.
  - нет. Abort the build if it's stuck. Если сборка застрянет, то попытаться ее удалить, чем ждать бесконечно кода она выполнится. Также можно намтроить стратегию этого поведения.
  - нет. Add timestamps to the Console Output. В лог выполнения будет ставиться время.
  - нет. Inspect build log for published Gradle build scans. Инспекция логов для Gradle
  - нет. With Ant?
- Сборка: (выбрать один вариант) - 01:45:50
  - нет. Invoke Gradle script
  - нет. Run with timeout
  - нет. Set build status to "pending" on GitHub commit
  - нет. Вызвать Ant
  - нет. Вызвать цели Maven верхнего уровня
  - нет. Выполнить команду Windows
  - да. Выполнить команду shell. Bash скрипты, команды. Например `ansible-playbook -i inventori/host.yml site.yaml`. Нужно также
  - Послесборочные операции




- 01:49:10 - начало процесса сборки



2. Сделать Declarative Pipeline Job, который будет запускать `molecule test` из любого вашего репозитория с ролью.
3. Перенести Declarative Pipeline в репозиторий в файл `Jenkinsfile`.
4. Создать Multibranch Pipeline на запуск `Jenkinsfile` из репозитория.
5. Создать Scripted Pipeline, наполнить его скриптом из [pipeline](./pipeline).
6. Внести необходимые изменения, чтобы Pipeline запускал `ansible-playbook` без флагов `--check --diff`, если не установлен параметр при запуске джобы (prod_run = True), по умолчанию параметр имеет значение False и запускает прогон с флагами `--check --diff`.
7. Проверить работоспособность, исправить ошибки, исправленный Pipeline вложить в репозиторий в файл `ScriptedJenkinsfile`. Цель: получить собранный стек ELK в Ya.Cloud.
8. Отправить две ссылки на репозитории в ответе: с ролью и Declarative Pipeline и c плейбукой и Scripted Pipeline.

## Необязательная часть

1. Создать скрипт на groovy, который будет собирать все Job, которые завершились хотя бы раз неуспешно. Добавить скрипт в репозиторий с решеним с названием `AllJobFailure.groovy`.
2. Дополнить Scripted Pipeline таким образом, чтобы он мог сначала запустить через Ya.Cloud CLI необходимое количество инстансов, прописать их в инвентори плейбука и после этого запускать плейбук. Тем самым, мы должны по нажатию кнопки получить готовую к использованию систему.

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
